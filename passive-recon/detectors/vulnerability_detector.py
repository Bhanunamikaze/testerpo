"""
Vulnerability Indicator Detector
=================================

Detects indicators of vulnerabilities and misconfigurations:
- Exposed debug endpoints
- Known vulnerable framework versions
- Information disclosure
- Default/weak configurations
- Exposed sensitive files
"""

import re
import logging
from typing import Dict, List


logger = logging.getLogger(__name__)


class VulnerabilityDetector:
    """
    Detects vulnerability indicators in passive recon data.
    Focuses on information disclosure and configuration issues.
    """

    # Indicators of potential vulnerabilities
    VULN_INDICATORS = {
        'debug_enabled': {
            'patterns': [
                r'debug\s*=\s*true',
                r'DEBUG\s*=\s*True',
                r'app\.debug\s*=\s*true',
                r'Laravel\s+.*\s+debug mode',
                r'Django\s+debug\s+page'
            ],
            'severity': 'high',
            'description': 'Debug mode enabled'
        },
        'directory_listing': {
            'patterns': [
                r'Index of /',
                r'Directory listing',
                r'Parent Directory'
            ],
            'severity': 'medium',
            'description': 'Directory listing enabled'
        },
        'exposed_git': {
            'patterns': [
                r'\.git/config',
                r'\.git/HEAD',
                r'\.git/index'
            ],
            'severity': 'high',
            'description': 'Exposed .git directory'
        },
        'exposed_env': {
            'patterns': [
                r'\.env',
                r'environment variables',
                r'APP_KEY=',
                r'DB_PASSWORD='
            ],
            'severity': 'critical',
            'description': 'Exposed environment configuration'
        },
        'backup_files': {
            'patterns': [
                r'\.(bak|old|backup|~)$',
                r'\.sql$',
                r'\.zip$',
                r'backup\.(tar|gz|zip)',
                r'dump\.sql'
            ],
            'severity': 'high',
            'description': 'Backup files exposed'
        },
        'stack_traces': {
            'patterns': [
                r'Stack trace:',
                r'Traceback \(most recent call',
                r'at line \d+ in file',
                r'Fatal error:',
                r'Exception in thread'
            ],
            'severity': 'medium',
            'description': 'Stack trace information disclosure'
        },
        'sql_errors': {
            'patterns': [
                r'SQL syntax.*MySQL',
                r'Warning.*mysql',
                r'PostgreSQL.*ERROR',
                r'ORA-\d{5}',
                r'SQLServer.*Error'
            ],
            'severity': 'medium',
            'description': 'SQL error message disclosure'
        },
        'framework_leakage': {
            'patterns': [
                r'X-Powered-By:\s*PHP',
                r'X-AspNet-Version',
                r'Server:\s*Apache',
                r'Laravel Framework',
                r'Ruby on Rails',
                r'Django/'
            ],
            'severity': 'low',
            'description': 'Framework/technology disclosure'
        },
        'default_credentials': {
            'patterns': [
                r'username:\s*admin.*password:\s*admin',
                r'admin:admin',
                r'root:root',
                r'test:test'
            ],
            'severity': 'critical',
            'description': 'Default credentials mentioned'
        },
        'sensitive_paths': {
            'patterns': [
                r'/admin',
                r'/phpmyadmin',
                r'/wp-admin',
                r'/console',
                r'/actuator',
                r'/swagger',
                r'/api-docs'
            ],
            'severity': 'medium',
            'description': 'Sensitive administrative paths'
        }
    }

    def __init__(self, config: Dict):
        """Initialize vulnerability detector."""
        self.config = config

    def detect(self, findings: List[Dict]) -> List[Dict]:
        """
        Scan findings for vulnerability indicators.

        Args:
            findings: List of findings to scan

        Returns:
            List of vulnerability findings
        """
        vuln_findings = []

        for finding in findings:
            # Extract scannable content
            content = self._extract_content(finding)
            url = finding.get('url', '')

            # Check each vulnerability indicator
            for vuln_type, vuln_config in self.VULN_INDICATORS.items():
                matches = self._check_patterns(
                    content,
                    url,
                    vuln_config['patterns']
                )

                if matches:
                    vuln_finding = {
                        **finding,
                        'type': 'vulnerability_indicator',
                        'category': 'vulnerability',
                        'vuln_type': vuln_type,
                        'vuln_description': vuln_config['description'],
                        'severity': vuln_config['severity'],
                        'indicators': matches,
                        'confidence': self._calculate_confidence(vuln_type, matches)
                    }
                    vuln_findings.append(vuln_finding)

        logger.info(f"Detected {len(vuln_findings)} vulnerability indicators")
        return vuln_findings

    def _extract_content(self, finding: Dict) -> str:
        """Extract content from finding."""
        fields = ['content', 'snippet', 'description', 'title', 'path']
        parts = []

        for field in fields:
            if field in finding and finding[field]:
                parts.append(str(finding[field]))

        return ' '.join(parts)

    def _check_patterns(self, content: str, url: str, patterns: List[str]) -> List[str]:
        """
        Check if any patterns match content or URL.

        Args:
            content: Content to check
            url: URL to check
            patterns: List of regex patterns

        Returns:
            List of matched patterns
        """
        matches = []
        combined = content + ' ' + url

        for pattern in patterns:
            try:
                if re.search(pattern, combined, re.IGNORECASE):
                    matches.append(pattern)
            except re.error:
                continue

        return matches

    def _calculate_confidence(self, vuln_type: str, matches: List[str]) -> float:
        """Calculate confidence score for vulnerability detection."""
        base_confidence = 0.6

        # More matches = higher confidence
        match_boost = min(0.3, len(matches) * 0.1)

        # Certain vuln types are more reliable
        high_confidence_types = ['exposed_env', 'exposed_git', 'default_credentials']
        if vuln_type in high_confidence_types:
            base_confidence += 0.2

        return min(1.0, base_confidence + match_boost)
